+++
title = "お宝概要"
+++

## お宝の構成要素

お宝は以下の構成要素からなる:

* 罠
* ランク
* GOLD
* GEM
* アイテム (最大 3 個)

お宝内にGOLD, GEM, アイテムのいずれかが存在するときに探索メニューコマンド「さがす」を実行するとお宝メニューへ遷移する。

### 罠

お宝内の罠は未確定、罠なし、罠ありのいずれかの状態をとる。

罠が未確定の場合、「さがす」でお宝シーンへ遷移した際に罠確定処理が行われる。`rand(1..=100) < (現在のマップの罠頻度)` なら罠あり、さもなくば罠なしとなる。

戦闘勝利によりお宝が更新される場合、罠は未確定となる。
イベントによりお宝が設定される場合、罠の設定はイベントごとに異なる。

### ランク

お宝ランクは `0..=10` の値で、お宝の外観および罠にかかった際のダメージに影響する。

お宝のランクと外観の対応は以下の通り:

* ランク `0..=1` ならば革袋。
* ランク `2..=4` ならば青宝箱。
* ランク `5..=7` ならば緑宝箱。
* ランク `8..=10` ならば金宝箱。

戦闘勝利によりお宝が更新される場合、お宝ランクは中身に見合った値となる。
イベントによりお宝が設定される場合、お宝ランクはイベントごとに異なる。

### GOLD

お宝内のGOLDは `u16` 値で、加算時のオーバーフローは無視される。

### GEM

お宝内のGEMは `u8` 値で、加算時のオーバーフローは無視される。

### アイテム

お宝内のアイテムは最大 3 個。満杯の場合、アイテムはそれ以上追加されない。

## お宝の更新

お宝は以下のケースで更新される:

* 戦闘勝利時、倒した敵たちに応じてGOLD, GEM, アイテムが追加される。上書きされるのではないことに注意。
  つまり、同じマスで連続して戦闘勝利すればお宝の内容は累積する。
* 特定のイベントによりGOLD/GEM/アイテムが設定される。
* お宝を開けてGOLD/GEM/アイテムを取得した際、取得したものが消える。
* 戦闘中に「にげる」コマンドや魔ML4「離脱」で逃げた場合、お宝の内容が全てクリアされる。
* PTが「歩いた」とみなされた場合、お宝の内容が全てクリアされる。以下のケースが該当する:
  - 探索シーンで前進移動が成功したとき(マップ端をまたいだかどうかによらず)
  - 探索シーンで後退移動が成功したとき(マップ端をまたごうとして座標が clamp された場合も含む)
  - マップIDを指定したワープ処理が発動したとき。以下のケースが該当する:
    + 僧ML4「浮上」成功時
    + 僧ML6「町へ」成功時
    + 魔ML5「テレポート」成功時
    + 魔ML7「アストラル」成功時
    + 戦闘前フェイズの「にげる」成功時
    + イベントによるマップID指定ワープ発動時
  - 魔ML6「通過」による移動が成功したとき
  - レイバン砦地下2のベルトコンベアにより移動させられたとき
  - ドラガデューン地下2 (4, 5) に進入して地面が揺れたとき
  - 魔法の砦地下2 (6, 4), (7, 4), (8, 4), (9, 4) のいずれかに進入してランダム移動させられたとき

お宝は以下のケースでは更新**されない**:

* お宝メニューで「あきらめる」またはキャンセルを選んだ場合(その場から動かず再度「さがす」を行えば取り直せる)
* お宝内のアイテムを取得中にPTのバックパックが満杯になって中断した場合(同様に取り直せる)
* 魔ML2「ジャンプ」による移動
* [戦闘前フェイズ](@/encounter/pre-battle/_index.md)の「おくりもの」成功時
* [戦闘前フェイズ](@/encounter/pre-battle/_index.md)の「こうさん」成功時(降参ワープの有無を問わず)
