<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>マイトアンドマジック (FC) 攻略&#x2F;解析 -お宝 -戦闘勝利時のお宝追加処理</title>

    <link rel="stylesheet" href="https://taotao54321.github.io/MightAndMagicJResource/css/main.css">
</head>
<body><header><a href="https://taotao54321.github.io/MightAndMagicJResource/">マイトアンドマジック (FC) 攻略&#x2F;解析</a>
            
                - 
            <a href="https://taotao54321.github.io/MightAndMagicJResource/treasure/">お宝</a>
            
            </header>

    <h1>戦闘勝利時のお宝追加処理</h1>

    <p>戦闘に勝利するとお宝の追加処理が行われる (注: 「にげる」や魔ML4「離脱」で逃げた場合はお宝の内容が全てクリアされる)。</p>
<p>追加されるお宝の内容は倒した敵たちに依存する。なお、本作は逃げた敵の管理がバグっているため、逃げた敵がいる場合は倒した敵リストが必ずしも正しくないことに注意。</p>
<p>以下、GOLD, GEM, アイテムの追加処理およびお宝ランクの決定処理について個別に述べる。</p>
<h2 id="goldnozhui-jia">GOLDの追加</h2>
<p>モンスターは種類ごとに「GOLDドロップ値」という <code>0..=3</code> の値を持ち、その値によりGOLDのドロップ量が決まる:</p>
<table><thead><tr><th>値</th><th>GOLD量</th></tr></thead><tbody>
<tr><td>0</td><td><code>0</code></td></tr>
<tr><td>1</td><td><code>rand(1..=15)</code></td></tr>
<tr><td>2</td><td><code>rand(1..=100)</code></td></tr>
<tr><td>3</td><td><code>256 * rand(1..=4)</code></td></tr>
</tbody></table>
<p>倒した全ての敵について上記のドロップ量がお宝内のGOLDに加算される。</p>
<h2 id="gemnozhui-jia">GEMの追加</h2>
<p>モンスターは種類ごとにGEMを落とすかどうかが決まっている。</p>
<p>倒した全ての敵について、その敵がGEMを落とすならば <code>rand(1..=6)</code> がお宝内のGEMに加算される。</p>
<h2 id="aitemunozhui-jia">アイテムの追加</h2>
<p>敵からのドロップアイテムには <code>0..=4</code> のランクがあり、モンスターごとにどのランクのアイテムを落とすかのマスクが設定されている。
このマスクは 5bit 値で、下位 bit から順にランク 0, 1, 2, 3, 4 のアイテムを落とすことを示す。</p>
<p>戦闘勝利時は、まず今回のお宝追加処理におけるアイテムランクマスクを決定する。これは全ての敵のドロップアイテムマスクを 5bit 値と見たときの最大値となる。</p>
<p>次に、対象のアイテムランクたちについて降順でドロップ判定を行う。ランク i のアイテムは <code>10 * (5 - i)</code> (%) の確率でドロップが発生する。
ドロップが発生した場合、そのランク内でアイテム抽選を行い、結果のアイテムをお宝に追加する。ただし既にお宝内のアイテムが満杯の場合は何もしない。</p>
<h3 id="dorotupugafa-sheng-sitaaitemurankunidui-suruaitemuchou-xuan">ドロップが発生したアイテムランクに対するアイテム抽選</h3>
<p>まずアイテムカテゴリをランダムに選ぶ。アイテムカテゴリおよびアイテムID範囲の表を以下に示す:</p>
<table><thead><tr><th>カテゴリ</th><th style="text-align: right">ID範囲</th><th style="text-align: right">ID個数</th><th>備考</th></tr></thead><tbody>
<tr><td>片手近接武器</td><td style="text-align: right"><code>1..=60</code></td><td style="text-align: right">60</td><td></td></tr>
<tr><td>射撃武器</td><td style="text-align: right"><code>61..=85</code></td><td style="text-align: right">25</td><td></td></tr>
<tr><td>両手近接武器</td><td style="text-align: right"><code>86..=120</code></td><td style="text-align: right">35</td><td></td></tr>
<tr><td>鎧</td><td style="text-align: right"><code>121..=155</code></td><td style="text-align: right">35</td><td></td></tr>
<tr><td>盾</td><td style="text-align: right"><code>156..=170</code></td><td style="text-align: right">25</td><td></td></tr>
<tr><td>その他</td><td style="text-align: right"><code>171..=230</code></td><td style="text-align: right">60</td><td>イベントアイテムを含まない</td></tr>
</tbody></table>
<p>そして、<code>(カテゴリ内最小アイテムID) + (アイテムランク)*(カテゴリ内ID個数)/5 + rand(0..=(カテゴリ内ID個数)/5-1)</code> を実際にドロップするアイテムIDとする。これはカテゴリ内ID範囲を 5 分割し、ランクに応じた範囲から抽選していることを意味する。たとえば、両手近接武器のIDは <code>86..=92</code>, <code>93..=99</code>, <code>100..=106</code>, <code>107..=113</code>, <code>114..=120</code> に 5 分割され、ランク 2 に対応するID範囲は <code>100.=106</code> となる (どのカテゴリもID個数は 5 の倍数であることに注意)。</p>
<p>ただし、射撃武器だけは上式の <code>(カテゴリ内最小アイテムID)</code> が誤って 5 と設定されている(本来は 61 が正しい)。よって、射撃武器が選ばれた場合の実際のID範囲は <code>5..=29</code>となる。つまり、<span class="xxx">戦闘勝利時に射撃武器がドロップすることは決してない。</span></p>
<h2 id="obao-rankunojue-ding">お宝ランクの決定</h2>
<p>まずお宝内のアイテムによる判定を試みる。これは「ドロップが発生したかどうか」のみに依存する(お宝内のアイテムが満杯で追加できなかった場合も発生した扱いとする)。判定はアイテムランクの降順で行う。</p>
<ul>
<li>アイテムランク <code>4</code> のドロップが発生した場合、お宝ランクは <code>10</code>。</li>
<li>アイテムランク <code>1..=3</code> のドロップが発生した場合、お宝ランクは <code>(アイテムランク) + 2 + rand(1..=4)</code>。</li>
<li>アイテムランク <code>0</code> のドロップが発生した場合、お宝ランクは <code>1 + rand(1..=4)</code>。</li>
</ul>
<p>お宝内にアイテムがない場合、お宝内にGEMがあればお宝ランクを <code>rand(2..=5)</code> とする。</p>
<p>お宝内にアイテムもGEMもない場合、GOLDによりお宝ランクを決定する:</p>
<ul>
<li>お宝内のGOLDが 256 以上ならばお宝ランクは <code>rand(0..=3)</code>。</li>
<li>さもなくばお宝ランクは <code>rand(0..=1)</code>。</li>
</ul>
</body>
</html>
